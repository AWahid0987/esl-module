<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ==========================
         FORM VIEW INHERIT
    =========================== -->
    <record id="view_move_form_fbr_inherit" model="ir.ui.view">
        <field name="name">account.move.form.fbr.inherit</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">

            <!-- Add "Send to FBR" button -->
            <xpath expr="//button[@name='action_post']" position="after">
                <button name="action_send_to_fbr"
                        string="Send to FBR"
                        type="object"
                        class="btn btn-info"
                        invisible="state != 'posted' or fbr_sent"/>
            </xpath>

            <!-- Add FBR Buyer Type Field -->
            <xpath expr="//div[@class='o_col']" position="after">
                <field name="fbr_buyer_type_id"
                       invisible="not fbr_buyer_type_id"
                       options="{'no_open': True}"/>
            </xpath>

            <!-- Add New Tab: FBR Pakistan -->
            <xpath expr="//notebook" position="inside">
                <page string="FBR Pakistan" name="fbr_pakistan">

                    <group colspan="2" class="mb-1">
                        <div colspan="2" class="o_group">
                            <div colspan="2"
                                 class="alert alert-info border-0 rounded-3 p-4 mb-2"
                                 style="background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
                                        border-left: 4px solid #2196f3 !important;
                                        border-right: 4px solid #2196f3 !important;">
                                <div colspan="2"
                                     class="d-flex align-items-center justify-content-center">
                                    <div class="text-center">
                                        <field name="fbr_digital_invoice_logo"
                                               widget="image"
                                               options="{'size': [0, 35]}"
                                               readonly="1"
                                               class="mb-3"/>
                                        <h4 class="mb-1 text-primary fw-bold">
                                            <i class="fa fa-shield-alt me-2"></i>
                                            FBR Pakistan Integration
                                        </h4>
                                        <p class="mb-0 text-muted small">
                                            Federal Board of Revenue - Tax Compliance System
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </group>

                    <group>
                        <group string="FBR Configuration">
                            <field name="fbr_document_type_id"/>
                            <field name="fbr_scenario_id"/>
                            <field name="fbr_sale_type_id"/>
                            <field name="fbr_reason_id"/>
                            <field name="fbr_province_id"/>
                        </group>

                        <group string="FBR Status">
                            <field name="fbr_sent" widget="boolean_toggle"/>
                            <field name="fbr_invoice_number" readonly="1"/>
                            <field name="fbr_qr_code" widget="image"
                                   class="oe_avatar"
                                   options="{'size': [150, 150]}"
                                   readonly="1"/>
                        </group>
                    </group>

                    <div colspan="4">
                        <button name="action_dynamic_payload"
                                type="object"
                                string="Generate Payload"
                                class="btn-link text-primary"
                                icon="fa-cogs"/>
                        <button name="action_generate_fbr_qr_code"
                                type="object"
                                string="Generate QR Code"
                                class="btn-link text-secondary"
                                icon="fa-qrcode"/>
                    </div>

                    <group string="FBR Data">
                        <field name="payload"
                               widget="ace"
                               readonly="1"
                               placeholder="JSON payload will appear here after generating..."/>
                        <field name="fbr_response"
                               widget="ace"
                               readonly="1"
                               placeholder="FBR response will appear here after submission..."/>
                    </group>

                </page>
            </xpath>

            <!-- Add Status Indicator in Header -->
            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button type="object"
                        name="action_send_to_fbr"
                        class="oe_stat_button"
                        icon="fa-paper-plane"
                        invisible="[('move_type', 'not in', ['out_invoice', 'out_refund'])]">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="fbr_sent" widget="boolean_toggle"/>
                        </span>
                        <span class="o_stat_text">FBR Status</span>
                    </div>
                </button>
            </xpath>

        </field>
    </record>

    <!-- ==========================
         TREE VIEW INHERIT (✅ FIXED)
    =========================== -->
    <record id="view_invoice_tree_fbr_inherit" model="ir.ui.view">
        <field name="name">account.move.tree.fbr.inherit</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_tree"/> <!-- ✅ Correct in Odoo 17 -->
        <field name="arch" type="xml">
            <!-- ✅ Changed xpath to target 'invoice_date' instead of 'payment_state' -->
            <xpath expr="//field[@name='invoice_date']" position="after">
                <field name="fbr_sent" widget="boolean_toggle" optional="show"/>
                <field name="fbr_invoice_number" optional="hide"/>
            </xpath>
        </field>
    </record>

</odoo>
